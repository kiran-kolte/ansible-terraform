---
- name: Terraform operations
  hosts: localhost
  gather_facts: false
  become: false

  environment:
    ARM_TENANT_ID: "{{ lookup('ansible.builtin.env', 'AZURE_TENANT') }}"
    ARM_SUBSCRIPTION_ID: "{{ lookup('ansible.builtin.env', 'AZURE_SUBSCRIPTION_ID') }}"
    ARM_CLIENT_ID: "{{ lookup('ansible.builtin.env', 'AZURE_CLIENT_ID') }}"
    ARM_CLIENT_SECRET: "{{ lookup('ansible.builtin.env', 'AZURE_SECRET') }}"

  vars:
    tf_project_dir: "{{ playbook_dir | dirname }}"
    tf_project_key: az_web_demo # this is used to identify the remote state in blob storage
    backend_conf: "{{ lookup('ansible.builtin.env', 'TF_BACKEND_CONFIG_FILE') }}"


  tasks:

    - name: Terraform Init
      cloud.terraform.terraform:
        project_path: "{{ tf_project_dir }}"
        force_init: true
        workspace: default

    - name: Terraform Plan
      when: tf_action == "plan"
      cloud.terraform.terraform:
        project_path: "{{ tf_project_dir }}"
        state: planned
      register: plan_result

    - name: Show Terraform Plan Output
      when: tf_action == "plan"
      debug:
        var: plan_result.stdout
        
    - name: Terraform apply | create_web_demo
      when: tf_action == "apply"
      cloud.terraform.terraform:
        project_path: "{{ tf_project_dir }}"
        state: present
        force_init: true
        backend_config:
          key: "{{ tf_project_key }}"
        backend_config_files:
          - "{{ backend_conf }}"
        variables:
          web_demo_ssh_pubkey: "{{ az_ssh_pubkey }}"
          web_vm_size: "{{ az_web_vm_size | default('Standard_DS1_v2') }}"

    - name: Terraform destroy | create_web_demo
      when: tf_action == "destroy"
      tags: [never, remove]
      cloud.terraform.terraform:
        project_path: "{{ tf_project_dir }}"
        state: absent
        force_init: true
        backend_config:
          key: "{{ tf_project_key }}"
        backend_config_files:
          - "{{ backend_conf }}"
        variables:
          web_demo_ssh_pubkey: "{{ az_ssh_pubkey }}"
          web_vm_size: "{{ az_web_vm_size | default('Standard_DS1_v2') }}"
